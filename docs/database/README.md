# XCloud数据库设计文档

## 概述
XCloud多云对账平台数据库采用PostgreSQL 14+，设计遵循企业级应用的最佳实践，支持大量账单数据的高效存储和查询。

## 核心设计原则

### 1. 数据分区策略
- **账单数据分表**: `billing_data_YYYYMM` 按月份自动分表
- **历史数据管理**: 支持自动创建分表和历史数据归档
- **查询性能优化**: 基于时间范围的分区剪枝

### 2. 审计和安全
- **软删除**: 所有业务表使用 `deleted_at` 实现软删除
- **审计字段**: 标准化的 `created_at`, `updated_at`, `created_by`, `updated_by` 字段
- **数据加密**: 敏感信息（API密钥）使用加密存储
- **访问控制**: 基于角色的权限管理

### 3. 数据完整性
- **外键约束**: 保证数据关系完整性
- **枚举类型**: 使用PostgreSQL枚举类型约束状态字段
- **检查约束**: 业务规则在数据库层面验证
- **唯一约束**: 防止重复数据

## 表结构说明

### 核心业务表

#### 1. 用户管理 (`users`)
- 系统用户认证和权限管理
- 支持管理员、操作员、查看者三种角色
- JWT认证基础数据

#### 2. 客户管理 (`customers`)
- 支持多级客户层次结构（parent_id实现树状结构）
- 客户状态管理（活跃、停用、暂停）
- 信用额度控制

#### 3. 云平台配置 (`cloud_providers`, `customer_cloud_configs`)
- 多云平台统一管理
- API配置和访问控制
- 客户级别的云平台绑定

#### 4. 合同管理 (`contracts`, `commission_rules`)
- 合同生命周期管理
- 灵活的返佣规则配置
- 支持阶梯式返佣计算

#### 5. 账单数据 (`billing_data_YYYYMM`)
- 按月自动分表存储大量账单数据
- 包含原始使用量和折扣后费用
- JSONB存储原始API响应和标签信息

#### 6. 返佣计算 (`commission_records`)
- 基于规则引擎的自动返佣计算
- 完整的返佣状态跟踪
- 支持批量结算和支付

### 系统支持表

#### 7. 同步日志 (`sync_logs`)
- 数据同步过程监控
- 错误日志和性能统计
- 支持同步状态查询

#### 8. 系统配置 (`system_configs`)
- 灵活的系统参数配置
- 支持加密配置项
- 不同数据类型支持

## 分表管理

### 自动分表函数
```sql
-- 创建指定月份的账单数据分表
SELECT create_billing_data_partition('2024-01-01'::DATE);
```

### 分表命名规则
- 格式: `billing_data_YYYYMM`
- 例如: `billing_data_202401` (2024年1月)

### 索引策略
每个分表自动创建以下索引：
- `customer_id` - 客户查询优化
- `provider` - 云平台筛选
- `billing_period` - 账期查询
- `billing_date` - 日期范围查询

## 数据类型选择

### 金额字段
- 使用 `DECIMAL(15,2)` 存储金额，避免浮点数精度问题
- 返佣比例使用 `DECIMAL(5,4)` 支持到万分位

### 时间字段
- 统一使用 `TIMESTAMP` 存储时间，设置亚洲/上海时区
- 日期字段使用 `DATE` 类型

### JSON字段
- 使用 `JSONB` 存储半结构化数据（标签、原始API响应）
- 支持高效查询和索引

## 性能优化建议

### 1. 查询优化
- 查询账单数据时指定明确的时间范围
- 利用分区剪枝提高查询性能
- 使用客户ID和时间组合索引

### 2. 数据维护
- 定期执行 `VACUUM` 和 `ANALYZE`
- 监控分表大小，适时归档历史数据
- 定期更新表统计信息

### 3. 连接池配置
- 后端服务建议使用连接池
- 读写分离：报表查询使用只读副本

## 初始化和迁移

### 1. 数据库初始化
```bash
# 使用Docker启动PostgreSQL
make docker-up

# 运行初始化脚本
psql -h localhost -U xcloud -d xcloud -f docs/database/schema.sql
```

### 2. 数据迁移
```bash
# 运行迁移脚本（开发阶段）
cd backend && go run cmd/migrate.go up
```

### 3. 初始数据
- 云服务商基础配置已自动插入
- 系统配置参数已预置
- 管理员账户需要通过API或脚本创建

## 监控和维护

### 关键监控指标
- 各分表数据量和增长趋势
- 查询响应时间
- 数据同步成功率
- 返佣计算准确性

### 备份策略
- 每日全量备份
- 事务日志连续备份
- 定期恢复测试

## 注意事项

1. **时区设置**: 确保数据库和应用时区一致（Asia/Shanghai）
2. **小数精度**: 金融计算避免使用浮点数，统一使用DECIMAL
3. **API密钥安全**: 生产环境必须加密存储云平台API密钥
4. **分表维护**: 需要定期创建未来月份的分表
5. **性能监控**: 关注大表查询性能，及时优化索引